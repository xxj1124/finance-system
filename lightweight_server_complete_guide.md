# 阿里云轻量应用服务器完整部署指南
## OpenAnolis（龙蜥版）系统 - Flask应用部署

---

## 目录

1. [准备工作](#1-准备工作)
2. [连接到服务器](#2-连接到服务器)
3. [防火墙配置](#3-防火墙配置)
4. [安装必要软件](#4-安装必要软件)
5. [上传项目文件](#5-上传项目文件)
6. [配置Python环境](#6-配置python环境)
7. [安装项目依赖](#7-安装项目依赖)
8. [修改应用配置](#8-修改应用配置)
9. [启动应用](#9-启动应用)
10. [测试访问应用](#10-测试访问应用)
11. [常见问题解答](#11-常见问题解答)
12. [后续维护](#12-后续维护)

---

## 1. 准备工作

### 1.1 本地计算机准备
- 确保本地计算机可以正常上网
- 记录阿里云服务器公网IP：**8.138.228.54**
- 记录服务器登录密码（创建服务器时设置）
- 确认本地项目文件位置：`E:\trae项目\finance\`

### 1.2 服务器准备
- 登录阿里云轻量应用服务器控制台
- 确认服务器状态为「运行中」

---

## 2. 连接到服务器

### 2.1 使用内置Workbench连接（推荐）

1. 登录阿里云轻量应用服务器控制台
2. 在服务器列表中找到您的实例（公网IP：8.138.228.54）
3. 点击实例名称进入服务器详情页
4. 在详情页顶部，点击「**远程连接**」按钮
5. 在弹出菜单中选择「**Workbench远程连接**」
6. 输入服务器登录密码
7. 点击「**确定**」按钮
8. 等待连接成功，进入黑色命令行界面

### 2.2 使用PuTTY连接（备选）

1. 下载并安装PuTTY：https://www.putty.org/
2. 打开PuTTY
3. 在「Host Name」中输入：`8.138.228.54`
4. 点击「Open」
5. 在登录提示中输入用户名：`root`
6. 输入服务器密码（输入时不显示）
7. 按回车键登录

---

## 3. 防火墙配置

轻量应用服务器使用「防火墙」管理端口，需要开放22、80和5000端口。

### 3.1 进入防火墙设置

1. 返回阿里云轻量应用服务器控制台
2. 进入服务器详情页
3. 在顶部导航栏点击「**防火墙**」选项卡

### 3.2 开放22端口（SSH连接）

1. 点击右上角「**添加规则**」按钮
2. 在弹出窗口填写：
   - **应用类型**：自定义
   - **规则方向**：入站
   - **协议**：TCP
   - **端口范围**：22
   - **授权对象**：0.0.0.0/0
   - **备注**：SSH连接端口
3. 点击「**确定**」

### 3.3 开放80端口（HTTP访问）

1. 再次点击「**添加规则**」
2. 在弹出窗口填写：
   - **应用类型**：HTTP(80)
   - **规则方向**：入站
   - **协议**：TCP
   - **端口范围**：80
   - **授权对象**：0.0.0.0/0
   - **备注**：HTTP访问端口
3. 点击「**确定**」

### 3.4 开放5000端口（应用访问）

1. 再次点击「**添加规则**」
2. 在弹出窗口填写：
   - **应用类型**：自定义
   - **规则方向**：入站
   - **协议**：TCP
   - **端口范围**：5000
   - **授权对象**：0.0.0.0/0
   - **备注**：Flask应用端口
3. 点击「**确定**」

---

## 4. 安装必要软件

在服务器命令行界面执行以下步骤：

### 4.1 更新系统

```bash
dnf update -y
```

等待命令执行完成（显示「Complete!」）

### 4.2 安装Python 3

```bash
dnf install -y python3 python3-pip
```

验证安装：
```bash
python3 --version
pip3 --version
```

**注意**：OpenAnolis系统中不需要单独安装python3-venv包，Python 3已内置venv模块用于创建虚拟环境。

### 4.3 安装SQLite数据库

```bash
dnf install -y sqlite sqlite-devel
```

验证安装：
```bash
sqlite3 --version
```

### 4.4 安装其他必要工具

```bash
dnf install -y wget curl vim unzip
```

---

## 5. 上传项目文件

### 5.1 创建项目目录

```bash
mkdir -p /var/www/finance
```

### 5.2 方法一：使用Workbench远程连接上传（推荐）

**注意：如果找不到「文件」按钮，请直接尝试方法二至方法四，这些方法更容易操作。**

1. 在服务器详情页顶部，点击「**远程连接**」按钮
2. 选择「**Workbench远程连接**」，输入密码登录
3. 进入Workbench命令行界面后，**查看顶部工具栏**：
   - 通常在界面顶部中间位置有一个「**文件**」图标或文字按钮
   - 如果是图标，看起来像一个文件夹或文件的形状
   - 如果找不到，请尝试点击界面上方的所有按钮，寻找包含「上传」功能的选项
4. 在下拉菜单中选择「**上传文件**」
5. 在弹出的文件选择窗口中，导航到本地项目目录：`E:\trae项目\finance\`
6. 选择所有文件和文件夹（按Ctrl+A全选）
7. 点击「**打开**」按钮，开始上传
8. 等待上传完成

**如果仍然找不到「文件」按钮，请立即尝试以下替代方法：**

### 5.3 方法二：使用命令助手上传

1. 在服务器详情页顶部，点击「**命令助手**」选项卡
2. 进入命令助手页面
3. 找到「**文件管理**」区域，点击「**上传文件**」按钮
4. 选择本地项目文件，点击「**打开**」
5. 等待上传完成

### 5.4 方法三：使用SCP命令从本地上传

1. 在本地计算机上打开PowerShell或命令提示符
2. 输入以下命令：
   ```bash
   scp -r "E:\trae项目\finance\*" root@8.138.228.54:/var/www/finance/
   ```
3. 按回车键执行，输入服务器登录密码
4. 等待文件上传完成

### 5.5 方法四：使用压缩包上传（推荐大文件）

1. 在本地将项目文件夹压缩为zip文件：`finance.zip`
2. 使用上述任意一种方法上传zip文件到服务器的`/root`目录
3. 在服务器上执行以下命令解压：
   ```bash
   # 进入项目目录
   cd /var/www/finance
   
   # 解压文件
   unzip /root/finance.zip
   ```

### 5.6 移动文件到项目目录（如果需要）

如果使用Workbench或命令助手上传，文件默认保存到`/root`目录，需要移动：

```bash
cp -r /root/* /var/www/finance/
```

### 5.7 验证文件上传成功

```bash
ls -la /var/www/finance/
```

如果能看到项目的所有文件和文件夹（如app、requirements.txt等），说明上传成功。

---

## 6. 配置Python环境

### 6.1 进入项目目录

```bash
cd /var/www/finance/
```

### 6.2 创建虚拟环境

由于OpenAnolis系统中Python 3已内置venv模块，直接使用以下命令创建：

```bash
python3 -m venv venv
```

### 6.3 激活虚拟环境

```bash
source venv/bin/activate
```

激活成功后，命令提示符前会显示 `(venv)`

### 6.4 升级pip

```bash
pip install --upgrade pip
```

---

## 7. 安装项目依赖

### 7.1 安装项目基础依赖

```bash
pip install -r requirements.txt
```

### 7.2 安装Gunicorn服务器

```bash
pip install gunicorn
```

---

## 8. 修改应用配置

### 8.1 打开配置文件

```bash
vim app/config.py
```

### 8.2 修改配置项

1. 按 `i` 键进入编辑模式

2. 找到并修改DEBUG模式（第19行左右）：
   ```python
   DEBUG = False
   ```

3. 确认SQLite数据库路径（第8行左右）：
   ```python
   SQLALCHEMY_DATABASE_URI = f'sqlite:///{os.path.join(BASE_DIR, "finance.db")}'
   ```

4. 按 `Esc` 键退出编辑模式

5. 输入 `:wq` 并按回车键保存退出

---

## 9. 启动应用

### 9.1 在后台启动应用

```bash
nohup gunicorn --bind 0.0.0.0:5000 app:app > finance.log 2>&1 &
```

### 9.2 验证应用是否启动成功

查看应用进程：
```bash
ps aux | grep gunicorn
```

查看应用日志：
```bash
tail -f finance.log
```

按 `Ctrl+C` 退出日志查看

---

## 10. 测试访问应用

### 10.1 使用浏览器访问

1. 打开本地浏览器
2. 在地址栏输入：`http://8.138.228.54:5000`
3. 按回车键访问
4. 预期结果：看到应用的登录页面或首页

### 10.2 检查应用状态

如果访问失败，检查应用状态：

```bash
# 查看应用进程
ps aux | grep gunicorn

# 查看详细日志
tail -n 100 finance.log

# 检查端口占用
lsof -i:5000
```

---

## 11. 常见问题解答

### 11.1 无法连接到服务器

**问题**：使用Workbench连接时提示密码错误

**解决方案**：
1. 确认密码是否正确（区分大小写）
2. 在服务器详情页点击「**重置密码**」
3. 设置新密码，等待1-2分钟后重新连接

### 11.2 文件上传失败

**解决方案**：
1. 检查文件大小是否超过限制（一般不超过1GB）
2. 尝试分批上传文件
3. 尝试使用压缩包上传：
   - 本地压缩项目文件为zip
   - 上传zip文件到服务器
   - 在服务器执行：`unzip /root/finance.zip -d /var/www/finance/`

### 11.3 应用启动失败

**解决方案**：
1. 检查虚拟环境是否激活
2. 检查依赖是否安装完整：`pip list`
3. 查看详细日志：`cat finance.log`
4. 检查端口是否被占用：`lsof -i:5000`

### 11.4 无法访问应用

**解决方案**：
1. 检查防火墙是否开放5000端口
2. 检查应用是否正在运行：`ps aux | grep gunicorn`
3. 检查应用日志是否有错误
4. 检查安全组是否开放端口（轻量应用服务器不需要）

---

## 12. 后续维护

### 12.1 重启应用

```bash
# 查找应用进程ID
ps aux | grep gunicorn

# 终止进程
kill <进程ID>

# 重新启动
nohup gunicorn --bind 0.0.0.0:5000 app:app > finance.log 2>&1 &
```

### 12.2 备份数据库

```bash
# 创建备份目录
mkdir -p /var/www/backup

# 备份数据库
cp /var/www/finance/finance.db /var/www/backup/finance_$(date +%Y%m%d_%H%M%S).db
```

### 12.3 更新应用

1. 上传新的项目文件到服务器
2. 停止当前应用进程
3. 重新启动应用

---

## 联系支持

如果您在部署过程中遇到任何问题：
1. 查看阿里云轻量应用服务器官方文档：https://help.aliyun.com/product/58958.html
2. 在阿里云控制台提交工单
3. 寻求技术人员帮助

祝您部署成功！🎉
