{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">预算分析 - {{ current_year }}年</h2>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- 总体预算使用情况 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>总体预算使用情况</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>总预算金额</label>
                                <p class="form-control-static h4">{{ total_budget }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>总已使用金额</label>
                                <p class="form-control-static h4">{{ total_used }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>总剩余金额</label>
                                <p class="form-control-static h4">{{ total_budget - total_used }}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>总体使用比例</label>
                                <p class="form-control-static h4">{{ "%.2f"|format(overall_ratio) }}%</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 预算使用进度条 -->
                    <div class="progress mt-4" style="height: 30px;">
                        <div class="progress-bar" role="progressbar" style="width: {{ overall_ratio }}%" aria-valuenow="{{ overall_ratio }}" aria-valuemin="0" aria-valuemax="100">
                            {{ "%.2f"|format(overall_ratio) }}%
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 各部门预算详情 -->
            <div class="card">
                <div class="card-header">
                    <h3>各部门预算详情</h3>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>部门</th>
                                <th>预算金额</th>
                                <th>已使用金额</th>
                                <th>剩余金额</th>
                                <th>使用比例</th>
                                <th>进度</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for budget in budgets %}
                            <tr>
                                <td>{{ budget.department }}</td>
                                <td>{{ budget.budget_amount }}</td>
                                <td>{{ budget.used_amount }}</td>
                                <td>{{ budget.budget_amount - budget.used_amount }}</td>
                                <td>{{ "%.2f"|format((budget.used_amount / budget.budget_amount) * 100) }}%</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: {{ (budget.used_amount / budget.budget_amount) * 100 }}%" aria-valuenow="{{ (budget.used_amount / budget.budget_amount) * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <a href="{{ url_for('main.budget_list') }}" class="btn btn-primary">返回预算列表</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}